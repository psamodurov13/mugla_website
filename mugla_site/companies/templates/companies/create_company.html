{% extends 'companies/companies.html' %}

{% load static %}
{% load tags_list_tag %}
{% load cropping %}
{% load crispy_forms_tags %}
{% load crispy_forms_filters %}

{% block title %}{{ block.super }}{% endblock %}

{% block h1 %}{{ title }}{% endblock %}

{% block content %}
    <div class="content col-sm-12 col-md-9 p-3">
        <div id="custom-form">


            <form id="create_company_ajax" enctype='multipart/form-data' novalidate method="post" >
                {% csrf_token %}


            <div id="crispy_form">
                {{ form|crispy }}


            </div>





            <input type="submit" class="btn btn-outline-info" value="Добавить компанию">

            </form>
        </div>
    </div>



{% endblock %}

{% block sidebar %}
{% include 'inc/_sidebar_blog_post.html' %}
{% endblock %}

{% block customjs %}
<script
   src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   <script type="text/javascript">
    // form upload
    $('#create_company_ajax').submit(function(e){
        e.preventDefault();
        $form = $(this)
        var formData = new FormData(this);
        $.ajax({
            url: '{% url "create_company_ajax" %}',
            type: 'POST',
            data: formData,
            success: function (response) {
                $('.error').remove();
                console.log(response)
                if(response.error){
                    alert(response.message)
                    grecaptcha.reset();
                    $.each(response.errors, function(name, error){
                        error = '<small class="text-muted error">' + error + '</small>'
                        $form.find('[name=' + name + ']').after(error);
                    })
                }
                else{
                    alert(response.message)
                    window.location = ""
                }
            },
            cache: false,
            contentType: false,
            processData: false
        });
    });
    // end
   </script>




{% comment %}
 <script>
    id_photo.onchange = evt => {
      const [file] = id_photo.files
      if (file) {
        preview_img.src = URL.createObjectURL(file)
      }
    }
</script>

<script type="text/javascript">
    $(document).on('submit', "#create_company_ajax", function (event){
      event.preventDefault();
      var create_form_id = $("#create_company_ajax");
      var photo_data = $('#id_photo').get(0).files
      var images_data = $('#id_gallery_images').get(0).files


      $.ajax({
          url: '{% url "create_company_ajax" %}',
          data: create_form_id.serialize(),
          type: "POST",
          enctype: "multipart/form-data",
          dataType: "json",
          header: {'X-CSRFToken': '{{ csrf_token }}'},
          success: function (response) {
              var success = response['success'];


              if (success) {
                  alert("Form valid")
                  console.log(create_form_id)
                  console.log(photo_data)
                  console.log(images_data);
              }
              else {
                    console.log(response)
                  console.log("Response with error ", response['form_html']);
                  $("#crispy_form").replaceWith(response['form_html']);
              }
          },
          failure: function (error) {
              console.log("Error django url ");
              alert('Error django url')
          }
      });
    });
</script>
{% endcomment %}
{% endblock %}